<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        button { padding: 10px 20px; font-size: 18px; margin-top: 10px; }
        input { display: block; margin: 5px auto; padding: 10px; font-size: 16px; width: 80%; }
    </style>
</head>
<body>
    <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
    <p id="user-info"></p>

    <form id="data-form">
        <input type="text" id="name" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" required>
        <input type="date" id="deadline" placeholder="–°—Ä–æ–∫ –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –î–û –ú–°–ö" required>
        <input type="number" id="amount" placeholder="–°—É–º–º–∞ —Ç–µ–Ω–¥–µ—Ä–∞" required>
        <input type="number" id="price" placeholder="—Ü–µ–Ω–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞">
        <input type="url" id="link" placeholder="–í–Ω–µ—à–Ω—è—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç–µ–Ω–¥–µ—Ä" required>
        <input type="text" id="notes" placeholder="–î–æ–ø–æ–ª–Ω–µ–Ω–∏—è">
        <input type="text" id="region" placeholder="–†–µ–≥–∏–æ–Ω" required>
        <input type="text" id="doc_status" placeholder="–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏" required>
        <input type="text" id="amount" placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–æ—Ä–≥–æ–≤">
        <input type="text" id="counter" placeholder="–†–∞—Å—á–µ—Ç—á–∏–∫">
        <input type="text" id="fz" placeholder="–§–ó">
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </form>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        document.getElementById("user-info").innerText = `–ü—Ä–∏–≤–µ—Ç, ${tg.initDataUnsafe.user?.first_name || '–ì–æ—Å—Ç—å'}!`;

        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –¥–Ω–µ–π
        function calculateDaysLeft() {
            let deadline = new Date(document.getElementById("deadline").value);
            let today = new Date();
            let timeDiff = deadline - today;
            return Math.ceil(timeDiff / (1000 * 60 * 60 * 24)); // –ü–µ—Ä–µ–≤–æ–¥ –≤ –¥–Ω–∏
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Google Sheets
        function sendDataToGoogleSheets(data) {
            const url = "https://script.google.com/macros/s/AKfycbz1gNm8JXVJJerCuYKV3lYBzkkqNdNL2-nlN9srryMMYKxoc0_DFx9SmWtVOB-bIbuNGg/exec"; // –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à URL –∏–∑ Google Apps Script
            console.log(url);
            console.log(data);
            fetch(url, {
              mode: 'cors',
              credentials: 'include'
                        });
            fetch(url, {
                method: "POST",
                mode: "no-cors",  // üöÄ –û—Ç–∫–ª—é—á–∞–µ–º CORS
                body: JSON.stringify(data),
                headers: { "Content-Type": "application/json" }
            })
            .then(response => response.json())
            // .then(data => console.log("Success:", data))
            .catch(error => console.error("Error:", error));
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        document.getElementById("data-form").addEventListener("submit", function (event) {
            event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            
            let formData = {
                id_unique: Date.now(),
                name: document.getElementById("name").value,
                deadline: document.getElementById("deadline").value,
                days_left: calculateDaysLeft(),
                amount: document.getElementById("amount").value,
                link: document.getElementById("link").value,
                notes: document.getElementById("notes").value,
                region: document.getElementById("region").value,
                doc_status: document.getElementById("doc_status").value,
                counter: document.getElementById("counter").value,
                fz: document.getElementById("fz").value
            };

            sendDataToGoogleSheets(formData);
        });
    </script>
</body>
</html>
